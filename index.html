<!-- ... existing HTML code ... -->
    <script type="module">
        // --- Service Worker Kaydı (PWA için) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
        // --- Service Worker Kaydı Sonu ---


        // --- DOM Elementleri ---
        // HATA DÜZELTMESİ: 'const' yerine 'let' kullanıldı ve atamalar 'init' içine taşındı
        let fileInput, fileNameDisplay, voiceSelect, repeatSelect, groupSelect,
            autoplayToggle, sentenceDisplay, progressText, prevBtn, playPauseBtn,
            nextBtn, playIcon, pauseIcon, selectionPopup, defineBtn,
            translateBtn, apiModal, modalTitle, modalContent, closeModalBtn;

        // --- Gemini API Anahtarı ---
        const apiKey = ""; // API anahtarı burada (güvenlik için normalde sunucuda olmalı)

        // --- Uygulama Durumu (State) ---
        let sentences = [];
        let currentIndex = 0;
        let currentRepeat = 0;
        let voices = [];
        let selectedVoice = null;
        let isSpeaking = false;
        let selectedWord = '';


        // --- Başlangıç Fonksiyonu ---
        function init() {
            // HATA DÜZELTMESİ: DOM elemanları, sayfa yüklendikten sonra burada atanıyor
            fileInput = document.getElementById('file-input');
            fileNameDisplay = document.getElementById('file-name-display');
            voiceSelect = document.getElementById('voice-select');
            repeatSelect = document.getElementById('repeat-select');
            groupSelect = document.getElementById('group-select');
            autoplayToggle = document.getElementById('auto-play-toggle');
            sentenceDisplay = document.getElementById('sentence-display');
            progressText = document.getElementById('progress-text');
            prevBtn = document.getElementById('prev-btn');
            playPauseBtn = document.getElementById('play-pause-btn');
            nextBtn = document.getElementById('next-btn');
            playIcon = document.getElementById('play-icon');
            pauseIcon = document.getElementById('pause-icon');
            selectionPopup = document.getElementById('selection-popup');
            defineBtn = document.getElementById('define-btn');
            translateBtn = document.getElementById('translate-btn');
            apiModal = document.getElementById('api-modal');
            modalTitle = document.getElementById('modal-title');
            modalContent = document.getElementById('modal-content');
            closeModalBtn = document.getElementById('close-modal-btn');


            // YENİ: Başlangıçta düğmeleri devre dışı bırak
            playPauseBtn.disabled = true; // Hata artık burada oluşmamalı
            nextBtn.disabled = true;
            prevBtn.disabled = true;

            // Sesleri yükle
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }

            // Kayıtlı veriyi yükle (localStorage)
            loadSavedData();

            // Olay Dinleyicileri (Event Listeners)
            fileInput.addEventListener('change', handleFile);
            voiceSelect.addEventListener('change', handleVoiceChange);
            playPauseBtn.addEventListener('click', playPause);
            nextBtn.addEventListener('click', goToNext);
            prevBtn.addEventListener('click', goToPrev);
            autoplayToggle.addEventListener('change', () => {});
            sentenceDisplay.addEventListener('mouseup', handleTextSelection);
            defineBtn.addEventListener('click', () => callGemini('define'));
            translateBtn.addEventListener('click', () => callGemini('translate'));
            closeModalBtn.addEventListener('click', hideModal);
            apiModal.addEventListener('click', (e) => {
                if (e.target === apiModal) hideModal();
            });
        }

        // --- Fonksiyonlar ---

        function loadSavedData() {
            const savedSentences = localStorage.getItem('shadowing_sentences');
            const savedIndex = localStorage.getItem('shadowing_index');
            const savedFile = localStorage.getItem('shadowing_file');

            if (savedSentences && savedFile) {
                try {
                    sentences = JSON.parse(savedSentences);
                    currentIndex = parseInt(savedIndex, 10) || 0;
                    fileNameDisplay.textContent = `(Loaded) ${savedFile}`;
                    
                    if (sentences.length > 0) {
                        updateDisplay();
                        // YENİ: Dosya yüklüyse düğmeleri aktif et
                        playPauseBtn.disabled = false;
                        nextBtn.disabled = false;
                        prevBtn.disabled = false;
                    }
                } catch (error) {
                    console.error("Failed to load saved data:", error);
                    localStorage.clear();
                }
            }
        }

        function loadVoices() {
            // YENİ: Sesler yüklenirken Oynat düğmesini devre dışı bırak
            playPauseBtn.disabled = true;
            voiceSelect.innerHTML = '<option>Loading voices...</option>';

            voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
            voiceSelect.innerHTML = '';
            
            if (voices.length === 0) {
                // Not: Bazı tarayıcılar (öz. mobil) sesleri 'onvoiceschanged' olmadan vermez,
                // veya kullanıcı etkileşimi (ilk tıklama) gerektirir.
                voiceSelect.innerHTML = '<option>No English voices</option>';
                // Düğmeyi yine de aktif edelim, varsayılan sesi kullanır
                if (sentences.length > 0) playPauseBtn.disabled = false;
                return;
            }

            const currentSelectedName = selectedVoice ? selectedVoice.name : null;

            voices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute('data-name', voice.name);
                voiceSelect.appendChild(option);
            });
            
            let voiceToSelect = voices[0];
            if (currentSelectedName) {
                 const previouslySelected = voices.find(v => v.name === currentSelectedName);
                 if (previouslySelected) voiceToSelect = previouslySelected;
            } else {
                 const preferredVoice = voices.find(v => v.name.includes("Google") || v.name.includes("David") || v.name.includes("Zira"));
                 if (preferredVoice) voiceToSelect = preferredVoice;
            }
            
            selectedVoice = voiceToSelect;
            voiceSelect.value = `${voiceToSelect.name} (${voiceToSelect.lang})`;

            // YENİ: Sesler yüklendikten sonra düğmeyi (eğer dosya varsa) aktif et
            if (sentences.length > 0) {
                playPauseBtn.disabled = false;
            }
        }

        function handleVoiceChange() {
            const selectedName = voiceSelect.options[voiceSelect.selectedIndex].getAttribute('data-name');
            selectedVoice = voices.find(voice => voice.name === selectedName);
            
            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false; 
                speak();
            }
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileNameDisplay.textContent = file.name;
            const reader = new FileReader();

            reader.onload = (e) => {
                const content = e.target.result;
                if (file.name.endsWith('.srt')) {
                    sentences = parseSrt(content);
                } else {
                    sentences = parseTxt(content);
                }
                
                if (sentences.length > 0) {
                    currentIndex = 0;
                    
                    try {
                        localStorage.setItem('shadowing_sentences', JSON.stringify(sentences));
                        localStorage.setItem('shadowing_file', file.name);
                    } catch (e) {
                        console.error("Failed to save to localStorage:", e);
                        sentenceDisplay.textContent = "Error: Could not save file. It might be too large.";
                    }
                    
                    updateDisplay();
                    // YENİ: Dosya yüklendiğinde düğmeleri aktif et
                    playPauseBtn.disabled = false;
                    nextBtn.disabled = false;
                    prevBtn.disabled = false;
                } else {
                    sentenceDisplay.textContent = "Could not parse file or file is empty.";
                    progressText.textContent = "Sentence 0 / 0";
                    // YENİ: Dosya boşsa düğmeleri devre dışı bırak
                    playPauseBtn.disabled = true;
                    nextBtn.disabled = true;
                    prevBtn.disabled = true;
                }
            };
            
            reader.readAsText(file);
        }

        function parseSrt(data) {
            return data
                .replace(/\r/g, '')
                .replace(/(^\d+$|^(\d{2}:){2}\d{2},\d{3} --> (\d{2}:){2}\d{2},\d{3}$)/gm, '')
                .replace(/<[^>]+>/g, '')
                .split('\n\n')
                .map(line => line.trim().replace(/\n/g, ' '))
                .filter(line => line.length > 0);
        }

        function parseTxt(data) {
            return data
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
        }

        function updateDisplay() {
            if (sentences.length === 0) return;
            
            const groupSize = parseInt(groupSelect.value, 10);
            let textToShow = [];

            for (let i = 0; i < groupSize; i++) {
                if (currentIndex + i < sentences.length) {
                    textToShow.push(sentences[currentIndex + i]);
                }
            }
            
            sentenceDisplay.textContent = textToShow.join(' ');
            progressText.textContent = `Sentence ${currentIndex + 1} / ${sentences.length}`;
            
            if (sentences.length > 0) {
                localStorage.setItem('shadowing_index', currentIndex.toString());
            }

            updatePlayPauseIcon(false);
        }

        // SÖZDİZİMİ HATASI DÜZELTMESİ
        function updatePlayPauseIcon(isPlaying) {
            if (isPlaying) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
        }

        // 4. Konuşma Motoru ve Kontroller
        function playPause() {
            if (isSpeaking) {
                // Duraklat
                speechSynthesis.cancel();
                isSpeaking = false;
                updatePlayPauseIcon(false);
            } else {
                // Oynat
                if (sentences.length > 0) {
                    // DÜZELTME 1: Sayaç SADECE burada sıfırlanmalı
                    currentRepeat = 0; 
                    speak();
                }
            }
        }

        // !!! MOBİL SES DEĞİŞTİRME DÜZELTMESİ BURADA !!!
        function speak() {
            if (isSpeaking) return; 

            isSpeaking = true;
            // DÜZELTME 2: Bu satır SİLİNDİ (veya 'playPause'a taşındı)
            // currentRepeat = 0; 
            updatePlayPauseIcon(true);
            
            const maxRepeats = parseInt(repeatSelect.value, 10);
            const groupSize = parseInt(groupSelect.value, 10);
            
            let textToSpeak = [];
            for (let i = 0; i < groupSize; i++) {
                if (currentIndex + i < sentences.length) {
                    textToSpeak.push(sentences[currentIndex + i]);
                }
            }

            const utterance = new SpeechSynthesisUtterance(textToSpeak.join(' '));
            
            // Sesi 'selectedVoice' global değişkeninden al
            utterance.voice = selectedVoice; 
            
            utterance.onend = handleSpeechEnd; 
            utterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                isSpeaking = false;
                updatePlayPauseIcon(false);
            };
            
            speechSynthesis.cancel(); 
            speechSynthesis.speak(utterance);
            // --- DEĞİŞİKLİK SONU ---
        }


        function handleSpeechEnd() {
            currentRepeat++;
            const maxRepeats = parseInt(repeatSelect.value, 10);

            if (currentRepeat < maxRepeats) {
                isSpeaking = false; // 'speak' fonksiyonunun tekrar çalışabilmesi için
                speak();
            } else {
                isSpeaking = false;
                const isAutoPlayOn = autoplayToggle.checked;
                
                if (isAutoPlayOn) {
                    goToNext();
                } else {
                    updatePlayPauseIcon(false);
                }
            }
        }

        function goToNext() {
            const groupSize = parseInt(groupSelect.value, 10);
            if (currentIndex + groupSize < sentences.length) {
                currentIndex += groupSize;
                updateDisplay();
                
                const isAutoPlayOn = autoplayToggle.checked;
                if (isAutoPlayOn) {
                    // DÜZELTME 3: Yeni cümleye geçerken sayaç burada da sıfırlanmalı
                    currentRepeat = 0;
                    speak();
                }
            } else {
                isSpeaking = false;
                updatePlayPauseIcon(false);
            }
        }

        function goToPrev() {
            const groupSize = parseInt(groupSelect.value, 10);
            if (currentIndex - groupSize >= 0) {
                currentIndex -= groupSize;
            } else {
                currentIndex = 0;
            }
            updateDisplay();

            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false;
                updatePlayPauseIcon(false);
            }
        }

        // 5. Kelime Seçimi ve API İşlemleri
        function handleTextSelection(event) {
            if (isSpeaking) return;

            const selection = window.getSelection().toString().trim();
            if (selection && selection.length > 0 && !selection.includes(' ')) {
                selectedWord = selection;
                
                // const popupWidth = selectionPopup.offsetWidth; // Bu satır 'null' hatası verebilir,
                // çünkü popup gizliyken genişliği 0 olabilir.
                
                let popupWidth = 150; // Ortalama bir genişlik varsay
                if (selectionPopup.offsetWidth > 0) {
                    popupWidth = selectionPopup.offsetWidth;
                }

                selectionPopup.style.top = `${event.clientY - 60}px`;
                selectionPopup.style.left = `${event.clientX - (popupWidth / 2)}px`;
                selectionPopup.classList.remove('hidden');
            } else {
                selectionPopup.classList.add('hidden');
            }
        }

        async function callGemini(action) {
            if (!selectedWord) return;
            
            selectionPopup.classList.add('hidden');
            showModal("Loading...", "Awaiting response from Gemini...");

            if (!apiKey) {
                console.warn("API key is not set. Using placeholder response.");
                showModal("API Key Missing", "Gemini API key is not set in the code. This feature is disabled.");
                return;
            }

            let prompt;
            if (action === 'define') {
                modalTitle.textContent = `Definition of "${selectedWord}"`;
                prompt = `Provide a simple, single-sentence English definition for the word: '${selectedWord}'.`;
            } else { // translate
                modalTitle.textContent = `Translation of "${selectedWord}"`;
                prompt = `Translate the English word '${selectedWord}' to Turkish. Provide only the translation.`;
            }

            const apiUrl = `https://generativelace.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    modalContent.textContent = text;
                } else {
                    modalContent.textContent = "Could not parse the response from Gemini.";
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal("Error", `Failed to fetch response: ${error.message}`);
            }
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) { 
                        throw new Error(`Retryable status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        function showModal(title, content) {
            modalTitle.textContent = title;
            modalContent.textContent = content;
            apiModal.classList.remove('hidden');
        }

        function hideModal() {
            apiModal.classList.add('hidden');
        }

        // --- Uygulamayı Başlat ---
        // HATA DÜZELTMESİ: 'init' fonksiyonu artık sayfa yüklendiğinde çağrılıyor.
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
