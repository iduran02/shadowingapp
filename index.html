<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtitle Shadowing Practice</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Shadowing App">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2563eb/white?text=S"> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-200 */
        }

        /* Oynat dÃ¼ÄŸmesi devre dÄ±ÅŸÄ± (disabled) stili */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ã–zel stil ile checkbox'Ä± 'toggle' (aÃ§ma-kapama) dÃ¼ÄŸmesine Ã§evirme */
        .toggle-checkbox:checked {
            @apply: bg-blue-600;
            right: 0;
            border-color: #2563eb; /* bg-blue-600 */
        }
        .toggle-checkbox:checked + .toggle-label {
            @apply: bg-blue-600;
        }
        .toggle-checkbox:checked + .toggle-label:after {
            left: calc(100% - 1.25rem); /* 1.25rem = w-5 */
            @apply: translate-x-full;
        }
        .toggle-label:after {
            content: '';
            @apply: absolute top-0.5 left-0.5 bg-white rounded-full h-5 w-5 shadow-md transition-transform duration-200 ease-in-out;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto space-y-6">
        
        <header class="text-center">
            <h1 class="text-3xl font-bold text-white">Subtitle Shadowing Practice</h1>
            <p class="text-lg text-gray-400" id="file-name-display">Upload a subtitle file to begin your practice.</p>
        </header>

        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                
                <div class="flex items-center justify-between md:justify-start md:space-x-4">
                    <label class="cursor-pointer inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <span>Change File</span>
                        <input type="file" id="file-input" class="hidden"> 
                    </label>

                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-300">Auto-Play:</span>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="auto-play-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="auto-play-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="voice-select" class="block text-sm font-medium text-gray-300">Voice:</label>
                        <select id="voice-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md text-white">
                            <option>Loading voices...</option>
                        </select>
                    </div>

                    <div>
                        <label for="repeat-select" class="block text-sm font-medium text-gray-300">Repeats:</label>
                        <select id="repeat-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md text-white">
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>

                    <div>
                        <label for="group-select" class="block text-sm font-medium text-gray-300">Group:</label>
                        <select id="group-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md text-white">
                            <option value="1" selected>1 Sentence</option>
                            <option value="2">2 Sentences</option>
                            <option value="3">3 Sentences</option>
                        </select>
                    </div>
                </div>

            </div>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg min-h-[200px] flex items-center justify-center">
            <p id="sentence-display" class="text-3xl md:text-4xl font-semibold text-center text-white">Welcome! Load a file to start.</p>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg shadow-lg space-y-4">
            <div class="text-center text-gray-400">
                <span id="progress-text">Sentence 0 / 0</span>
            </div>
            
            <div class="flex items-center justify-center space-x-6">
                <button id="prev-btn" class="text-gray-400 hover:text-white transition-colors" title="Previous">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-11.707a1 1 0 00-1.414 0L6.293 9.293a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L8.414 10l2.293-2.293a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
                </button>
                
                <button id="play-pause-btn" class="p-4 bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-all shadow-lg" title="Play">
                    <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd"></path></svg>
                </button>

                <button id="next-btn" class="text-gray-400 hover:text-white transition-colors" title="Next">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-11.707a1 1 0 00-1.414 0L6.293 9.293a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L8.414 10l2.293-2.293a1 1 0 000-1.414z" clip-rule="evenodd" transform="rotate(180 10 10)"></path></svg>
                </button>
            </div>
        </div>

    </div>

    <div id="selection-popup" class="hidden absolute bg-gray-700 border border-gray-600 rounded-md shadow-lg p-1 z-50 flex space-x-1">
        <button id="define-btn" class="px-3 py-1 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded">Define (EN)</button>
        <button id="translate-btn" class="px-3 py-1 text-sm text-white bg-green-600 hover:bg-green-700 rounded">Translate (TR)</button>
    </div>

    <div id="api-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg relative">
            <button id="close-modal-btn" class="absolute top-2 right-2 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h3 class="text-lg font-medium text-white mb-4" id="modal-title">Gemini API Result</h3>
            <div id="modal-content" class="text-gray-300 max-h-60 overflow-y-auto">
                </div>
        </div>
    </div>


    <script type="module">
        // --- Service Worker KaydÄ± (PWA iÃ§in) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
        // --- Service Worker KaydÄ± Sonu ---


        // --- DOM Elementleri ---
        let fileInput, fileNameDisplay, voiceSelect, repeatSelect, groupSelect,
            autoplayToggle, sentenceDisplay, progressText, prevBtn, playPauseBtn,
            nextBtn, playIcon, pauseIcon, selectionPopup, defineBtn,
            translateBtn, apiModal, modalTitle, modalContent, closeModalBtn;

        // --- Gemini API AnahtarÄ± ---
        const apiKey = ""; // API anahtarÄ± burada (gÃ¼venlik iÃ§in normalde sunucuda olmalÄ±)

        // --- Uygulama Durumu (State) ---
        let sentences = [];
        let currentIndex = 0;
        let currentRepeat = 0;
        let voices = [];
        let selectedVoice = null;
        let isSpeaking = false;
        let selectedWord = '';


        // --- BaÅŸlangÄ±Ã§ Fonksiyonu ---
        function init() {
            // HATA DÃœZELTMESÄ°: DOM elemanlarÄ±, sayfa yÃ¼klendikten sonra burada atanÄ±yor
            fileInput = document.getElementById('file-input');
            fileNameDisplay = document.getElementById('file-name-display');
            voiceSelect = document.getElementById('voice-select');
            repeatSelect = document.getElementById('repeat-select');
            groupSelect = document.getElementById('group-select');
            autoplayToggle = document.getElementById('auto-play-toggle');
            sentenceDisplay = document.getElementById('sentence-display');
            progressText = document.getElementById('progress-text');
            prevBtn = document.getElementById('prev-btn');
            playPauseBtn = document.getElementById('play-pause-btn');
            nextBtn = document.getElementById('next-btn');
            playIcon = document.getElementById('play-icon');
            pauseIcon = document.getElementById('pause-icon');
            selectionPopup = document.getElementById('selection-popup');
            defineBtn = document.getElementById('define-btn');
            translateBtn = document.getElementById('translate-btn');
            apiModal = document.getElementById('api-modal');
            modalTitle = document.getElementById('modal-title');
            modalContent = document.getElementById('modal-content');
            closeModalBtn = document.getElementById('close-modal-btn');


            // YENÄ°: BaÅŸlangÄ±Ã§ta dÃ¼ÄŸmeleri devre dÄ±ÅŸÄ± bÄ±rak
            playPauseBtn.disabled = true; 
            nextBtn.disabled = true;
            prevBtn.disabled = true;

            // Sesleri yÃ¼kle
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }

            // KayÄ±tlÄ± veriyi yÃ¼kle (localStorage)
            loadSavedData();

            // Olay Dinleyicileri (Event Listeners)
            fileInput.addEventListener('change', handleFile);
            voiceSelect.addEventListener('change', handleVoiceChange);
            playPauseBtn.addEventListener('click', playPause);
            nextBtn.addEventListener('click', goToNext);
            prevBtn.addEventListener('click', goToPrev);
            autoplayToggle.addEventListener('change', () => {});
            sentenceDisplay.addEventListener('mouseup', handleTextSelection);
            defineBtn.addEventListener('click', () => callGemini('define'));
            translateBtn.addEventListener('click', () => callGemini('translate'));
            closeModalBtn.addEventListener('click', hideModal);
            apiModal.addEventListener('click', (e) => {
                if (e.target === apiModal) hideModal();
            });
        }

        // --- Fonksiyonlar ---

        function loadSavedData() {
            const savedSentences = localStorage.getItem('shadowing_sentences');
            const savedIndex = localStorage.getItem('shadowing_index');
            const savedFile = localStorage.getItem('shadowing_file');

            if (savedSentences && savedFile) {
                try {
                    sentences = JSON.parse(savedSentences);
                    currentIndex = parseInt(savedIndex, 10) || 0;
                    fileNameDisplay.textContent = `(Loaded) ${savedFile}`;
                    
                    if (sentences.length > 0) {
                        updateDisplay();
                        // Dosya yÃ¼klÃ¼yse dÃ¼ÄŸmeleri aktif et
                        playPauseBtn.disabled = false;
                        nextBtn.disabled = false;
                        prevBtn.disabled = false;
                    }
                } catch (error) {
                    console.error("Failed to load saved data:", error);
                    localStorage.clear();
                }
            }
        }

        function loadVoices() {
            // Sesler yÃ¼klenirken Oynat dÃ¼ÄŸmesini devre dÄ±ÅŸÄ± bÄ±rak
            playPauseBtn.disabled = true;
            voiceSelect.innerHTML = '<option>Loading voices...</option>';

            voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
            voiceSelect.innerHTML = '';
            
            if (voices.length === 0) {
                voiceSelect.innerHTML = '<option>No English voices</option>';
                if (sentences.length > 0) playPauseBtn.disabled = false;
                return;
            }

            const currentSelectedName = selectedVoice ? selectedVoice.name : null;

            voices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute('data-name', voice.name);
                voiceSelect.appendChild(option);
            });
            
            let voiceToSelect = voices[0];
            if (currentSelectedName) {
                const previouslySelected = voices.find(v => v.name === currentSelectedName);
                if (previouslySelected) voiceToSelect = previouslySelected;
            } else {
                const preferredVoice = voices.find(v => v.name.includes("Google") || v.name.includes("David") || v.name.includes("Zira"));
                if (preferredVoice) voiceToSelect = preferredVoice;
            }
            
            selectedVoice = voiceToSelect;
            voiceSelect.value = `${voiceToSelect.name} (${voiceToSelect.lang})`;

            // Sesler yÃ¼klendikten sonra dÃ¼ÄŸmeyi (eÄŸer dosya varsa) aktif et
            if (sentences.length > 0) {
                playPauseBtn.disabled = false;
            }
        }

        function handleVoiceChange() {
            const selectedName = voiceSelect.options[voiceSelect.selectedIndex].getAttribute('data-name');
            selectedVoice = voices.find(voice => voice.name === selectedName);
            
            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false; 
                speak();
            }
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileNameDisplay.textContent = file.name;
            const reader = new FileReader();

            reader.onload = (e) => {
                const content = e.target.result;
                if (file.name.endsWith('.srt')) {
                    sentences = parseSrt(content);
                } else {
                    sentences = parseTxt(content);
                }
                
                if (sentences.length > 0) {
                    currentIndex = 0;
                    
                    try {
                        localStorage.setItem('shadowing_sentences', JSON.stringify(sentences));
                        localStorage.setItem('shadowing_file', file.name);
                    } catch (e) {
                        console.error("Failed to save to localStorage:", e);
                        sentenceDisplay.textContent = "Error: Could not save file. It might be too large.";
                    }
                    
                    updateDisplay();
                    // Dosya yÃ¼klendiÄŸinde dÃ¼ÄŸmeleri aktif et
                    playPauseBtn.disabled = false;
                    nextBtn.disabled = false;
                    prevBtn.disabled = false;
                } else {
                    sentenceDisplay.textContent = "Could not parse file or file is empty.";
                    progressText.textContent = "Sentence 0 / 0";
                    // Dosya boÅŸsa dÃ¼ÄŸmeleri devre dÄ±ÅŸÄ± bÄ±rak
                    playPauseBtn.disabled = true;
                    nextBtn.disabled = true;
                    prevBtn.disabled = true;
                }
            };
            
            reader.readAsText(file);
        }

        function parseSrt(data) {
            return data
                .replace(/\r/g, '')
                .replace(/(^\d+$|^(\d{2}:){2}\d{2},\d{3} --> (\d{2}:){2}\d{2},\d{3}$)/gm, '')
                .replace(/<[^>]+>/g, '')
                .split('\n\n')
                .map(line => line.trim().replace(/\n/g, ' '))
                .filter(line => line.length > 0);
        }

        function parseTxt(data) {
            return data
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
        }

        function updateDisplay() {
            if (sentences.length === 0) return;
            
            const groupSize = parseInt(groupSelect.value, 10);
            let textToShow = [];

            for (let i = 0; i < groupSize; i++) {
                if (currentIndex + i < sentences.length) {
                    textToShow.push(sentences[currentIndex + i]);
                }
            }
            
            sentenceDisplay.textContent = textToShow.join(' ');
            progressText.textContent = `Sentence ${currentIndex + 1} / ${sentences.length}`;
            
            if (sentences.length > 0) {
                localStorage.setItem('shadowing_index', currentIndex.toString());
            }

            updatePlayPauseIcon(false);
        }

        function updatePlayPauseIcon(isPlaying) {
            if (isPlaying) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
        }

        // 4. Kontroller (Play/Pause)
        function playPause() {
            if (isSpeaking) {
                // Duraklat
                speechSynthesis.cancel();
                isSpeaking = false;
                updatePlayPauseIcon(false);
            } else {
                // Oynat
                if (sentences.length > 0) {
                    // Oynatmaya baÅŸlarken sayaÃ§ sÄ±fÄ±rlanmalÄ±
                    currentRepeat = 0; 
                    speak();
                }
            }
        }
        
        // YENÄ° FONKSÄ°YON 1: Ses ve HÄ±z AyarlarÄ±nÄ± Dinamik Olarak Belirleme
        function getVoiceAndRate(repeatIndex, maxRepeats, indexInGroup, totalInGroup) {
            // ðŸ“¢ KULLANICI SES AYARLARI: TarayÄ±cÄ±nÄ±zda yÃ¼klÃ¼ olan seslerin TAM ismini girin.
            const MANUEL_ERKEK_SESI_ADI = "Microsoft David - English (United States)"; 
            const MANUEL_KADIN_SESI_ADI = "Google US English"; 
            const MANUEL_ALTERNATIF_SES_ADI = "Microsoft Zira - English (United States)"; 
            
            const defaultVoice = selectedVoice || voices.find(v => v.default) || voices[0];
            const maleVoice = voices.find(v => v.name === MANUEL_ERKEK_SESI_ADI) || defaultVoice;
            const femaleVoice = voices.find(v => v.name === MANUEL_KADIN_SESI_ADI) || defaultVoice;
            const alternateVoice = voices.find(v => v.name === MANUEL_ALTERNATIF_SESI_ADI) || defaultVoice;

            let voiceToUse;
            let rateToUse; 

            // 1. Tonalite (HÄ±z) AyarÄ±: Tekrar sayÄ±sÄ±na baÄŸlÄ±dÄ±r (Clear/Natural/Fluent)
            switch (repeatIndex % 3) {
                case 0: // CLEAR (YavaÅŸ)
                    rateToUse = 0.8; 
                    break;
                case 1: // NATURAL (Normal)
                    rateToUse = 1.0; 
                    break;
                case 2: // FLUENT (HÄ±zlÄ±)
                    rateToUse = 1.1; 
                    break;
                default:
                    rateToUse = 1.0;
            }
            
            // 2. Ses (Cinsiyet) AyarÄ±: CÃ¼mlenin gruptaki sÄ±rasÄ±na baÄŸlÄ±dÄ±r (Role-Play)
            if (totalInGroup > 1) {
                // CÃ¼mle Sesi MantÄ±ÄŸÄ±: S1=Erkek, S2=KadÄ±n, S3=Alternatif, S4=Erkek... (3 sesli dÃ¶ngÃ¼)
                switch (indexInGroup % 3) {
                    case 0: // CÃ¼mle 1, 4, 7...
                        voiceToUse = maleVoice; 
                        break;
                    case 1: // CÃ¼mle 2, 5, 8...
                        voiceToUse = femaleVoice; 
                        break;
                    case 2: // CÃ¼mle 3, 6, 9...
                        voiceToUse = alternateVoice; 
                        break;
                }
            } else {
                 // Grup bÃ¼yÃ¼klÃ¼ÄŸÃ¼ 1 ise, ses tekrar sayÄ±sÄ±na gÃ¶re deÄŸiÅŸsin (eski mantÄ±k)
                 switch (repeatIndex % 3) {
                    case 0: 
                        voiceToUse = maleVoice; break;
                    case 1: 
                        voiceToUse = femaleVoice; break;
                    case 2: 
                        voiceToUse = alternateVoice; break;
                    default:
                        voiceToUse = defaultVoice;
                }
            }

            return { voice: voiceToUse, rate: rateToUse };
        }


        // YENÄ° FONKSÄ°YON 2: KonuÅŸma Motoru (TAMAMEN REVÄ°ZE EDÄ°LDÄ° - Zincirleme YapÄ±)
        function speak() {
            if (isSpeaking) return;

            isSpeaking = true;
            updatePlayPauseIcon(true);
            
            const maxRepeats = parseInt(repeatSelect.value, 10);
            const groupSize = parseInt(groupSelect.value, 10);
            
            // KonuÅŸulacak cÃ¼mleleri ayÄ±r (sentencesInGroup)
            const sentencesInGroup = [];
            for (let i = 0; i < groupSize; i++) {
                if (currentIndex + i < sentences.length) {
                    sentencesInGroup.push(sentences[currentIndex + i]);
                }
            }
            
            if (sentencesInGroup.length === 0) {
                isSpeaking = false;
                updatePlayPauseIcon(false);
                return;
            }

            // --- Recursive Group Repeater (DÄ±ÅŸ DÃ¶ngÃ¼: Tekrar SayÄ±sÄ±) ---
            function startNextRepeat() {
                if (currentRepeat >= maxRepeats) {
                    // TÃ¼m tekrarlar bitti
                    isSpeaking = false;
                    updatePlayPauseIcon(false);
                    
                    if (autoplayToggle.checked) {
                        goToNext(); 
                    }
                    return;
                }

                // --- Inner Speaker (Ä°Ã§ DÃ¶ngÃ¼: Gruptaki CÃ¼mleler) ---
                let indexInGroup = 0;
                function speakNextSentence() {
                    if (indexInGroup >= sentencesInGroup.length) {
                        // Gruptaki tÃ¼m cÃ¼mleler sÃ¶ylendi. Bir sonraki dÄ±ÅŸ tekrara geÃ§.
                        currentRepeat++;
                        // Tekrarlar arasÄ±nda kÃ¼Ã§Ã¼k bir gecikme ekleyelim (500ms)
                        setTimeout(startNextRepeat, 500); 
                        return;
                    }

                    const textToSpeak = sentencesInGroup[indexInGroup];
                    
                    // Ses ve HÄ±z ayarlarÄ±nÄ± al
                    const { voice: voiceToUse, rate: rateToUse } = getVoiceAndRate(
                        currentRepeat, 
                        maxRepeats, 
                        indexInGroup,
                        sentencesInGroup.length 
                    );

                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.voice = voiceToUse;
                    utterance.rate = rateToUse; 
                    utterance.onend = () => {
                        indexInGroup++;
                        speakNextSentence(); // Bir sonraki cÃ¼mleyi baÅŸlat
                    };
                    utterance.onerror = (event) => {
                         console.error('SpeechSynthesisUtterance.onerror', event);
                         // Hata durumunda dÃ¶ngÃ¼yÃ¼ kes ve bitir
                         isSpeaking = false;
                         updatePlayPauseIcon(false);
                    };

                    speechSynthesis.cancel();
                    speechSynthesis.speak(utterance);
                    
                    // UI GÃ¼ncelleme (Hangi cÃ¼mlenin okunduÄŸunu gÃ¶ster)
                    const progressInfo = ` (Tekrar ${currentRepeat + 1}/${maxRepeats} - HÄ±z: ${rateToUse.toFixed(1)} - Ses: ${voiceToUse.name.split(' ')[0]})`;
                    progressText.textContent = `Sentence ${currentIndex + indexInGroup + 1} / ${sentences.length}${progressInfo}`;

                    // Arka Plan KontrolÃ¼nÃ¼ kur (Sadece ilk cÃ¼mlenin ilk tekrarÄ±nda)
                    if (currentRepeat === 0 && indexInGroup === 0) {
                         setupMediaSession(voiceToUse, sentencesInGroup.join(' '));
                    }
                }
                
                // Bu tekrarÄ±n ilk cÃ¼mlesini baÅŸlat
                speakNextSentence();
            }

            // BaÅŸlangÄ±Ã§
            currentRepeat = 0; 
            startNextRepeat();
        }

        // YENÄ° FONKSÄ°YON 3: Arka Planda Ã‡alma (Media Session API)
        function setupMediaSession(voice, text) {
            if ('mediaSession' in navigator) {
                // Medya Bilgilerini Ayarla (Kilit ekranÄ±nda gÃ¶rÃ¼nmesi iÃ§in)
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'Shadowing Practice',
                    artist: `Ses: ${voice.name} | Tekrar: ${currentRepeat + 1}`,
                    album: text.substring(0, 50) + '...',
                    artwork: [
                        { src: 'https://placehold.co/96x96/2563eb/white?text=S', sizes: '96x96', type: 'image/png' },
                        { src: 'https://placehold.co/512x512/2563eb/white?text=S', sizes: '512x512', type: 'image/png' },
                    ]
                });

                // Kontrol TuÅŸlarÄ±nÄ± TanÄ±mla (Kilit ekranÄ±nda/Bildirim merkezinde gÃ¶rÃ¼nÃ¼r)
                navigator.mediaSession.setActionHandler('play', () => { 
                    if (!isSpeaking) playPause(); 
                });
                navigator.mediaSession.setActionHandler('pause', () => { 
                    if (isSpeaking) playPause(); 
                });

                // Ä°leri/Geri Atla (CÃ¼mle atlama)
                navigator.mediaSession.setActionHandler('nexttrack', () => { 
                    speechSynthesis.cancel(); 
                    isSpeaking = false; 
                    goToNext(); 
                });
                navigator.mediaSession.setActionHandler('previoustrack', () => { 
                    speechSynthesis.cancel(); 
                    isSpeaking = false; 
                    goToPrev(); 
                });

                // DiÄŸer aksiyonlarÄ± kapatÄ±yoruz, Ã§Ã¼nkÃ¼ Speech Synthesis ile tam kontrol zor.
                navigator.mediaSession.setActionHandler('seekbackward', null);
                navigator.mediaSession.setActionHandler('seekforward', null);
            }
        }


        function goToNext() {
            const groupSize = parseInt(groupSelect.value, 10);
            if (currentIndex + groupSize < sentences.length) {
                currentIndex += groupSize;
                updateDisplay();
                
                const isAutoPlayOn = autoplayToggle.checked;
                if (isAutoPlayOn) {
                    // Yeni cÃ¼mleye geÃ§erken sayaÃ§ sÄ±fÄ±rlanmalÄ±
                    currentRepeat = 0;
                    speak();
                }
            } else {
                isSpeaking = false;
                updatePlayPauseIcon(false);
            }
        }

        function goToPrev() {
            const groupSize = parseInt(groupSelect.value, 10);
            if (currentIndex - groupSize >= 0) {
                currentIndex -= groupSize;
            } else {
                currentIndex = 0;
            }
            updateDisplay();

            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false;
                updatePlayPauseIcon(false);
            }
        }

        // 5. Kelime SeÃ§imi ve API Ä°ÅŸlemleri
        function handleTextSelection(event) {
            if (isSpeaking) return;

            const selection = window.getSelection().toString().trim();
            if (selection && selection.length > 0 && !selection.includes(' ')) {
                selectedWord = selection;
                
                let popupWidth = 150; // Ortalama bir geniÅŸlik varsay
                if (selectionPopup && selectionPopup.offsetWidth > 0) {
                    popupWidth = selectionPopup.offsetWidth;
                }

                selectionPopup.style.top = `${event.clientY - 60}px`;
                selectionPopup.style.left = `${event.clientX - (popupWidth / 2)}px`;
                selectionPopup.classList.remove('hidden');
            } else {
                if (selectionPopup) {
                    selectionPopup.classList.add('hidden');
                }
            }
        }

        async function callGemini(action) {
            if (!selectedWord) return;
            
            selectionPopup.classList.add('hidden');
            showModal("Loading...", "Awaiting response from Gemini...");

            if (!apiKey) {
                console.warn("API key is not set. Using placeholder response.");
                showModal("API Key Missing", "Gemini API key is not set in the code. This feature is disabled.");
                return;
            }

            let prompt;
            if (action === 'define') {
                modalTitle.textContent = `Definition of "${selectedWord}"`;
                prompt = `Provide a simple, single-sentence English definition for the word: '${selectedWord}'.`;
            } else { // translate
                modalTitle.textContent = `Translation of "${selectedWord}"`;
                prompt = `Translate the English word '${selectedWord}' to Turkish. Provide only the translation.`;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    modalContent.textContent = text;
                } else {
                    modalContent.textContent = "Could not parse the response from Gemini.";
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal("Error", `Failed to fetch response: ${error.message}`);
            }
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) { 
                        throw new Error(`Retryable status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        function showModal(title, content) {
            modalTitle.textContent = title;
            modalContent.textContent = content;
            apiModal.classList.remove('hidden');
        }

        function hideModal() {
            apiModal.classList.add('hidden');
        }

        // --- UygulamayÄ± BaÅŸlat ---
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
